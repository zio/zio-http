<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digest Authentication Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            padding: 40px;
            max-width: 800px;
            width: 100%;
            position: relative;
            overflow: hidden;
            animation: slideIn 0.6s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .auth-logo {
            font-size: 48px;
            margin-bottom: 20px;
            color: #333;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
            font-weight: 700;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 16px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .user-card {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .user-card.active {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .user-card h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .user-card p {
            color: #666;
            font-size: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input[type="text"]:focus, input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .endpoints {
            display: grid;
            gap: 15px;
            margin-bottom: 30px;
        }

        .endpoint-section {
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .endpoint-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
            font-weight: 600;
        }

        .endpoint-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }

        .btn:hover:before {
            left: 100%;
        }

        .btn-profile {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .btn-admin {
            background: linear-gradient(45deg, #FF6B6B, #ee5a52);
            color: white;
        }

        .btn-public {
            background: linear-gradient(45deg, #4ECDC4, #44a08d);
            color: white;
        }

        .btn-clear {
            background: linear-gradient(45deg, #666, #555);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .response-area {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 15px;
            font-family: 'SF Mono', Monaco, monospace;
            font-size: 14px;
            line-height: 1.5;
            min-height: 200px;
            overflow-y: auto;
            border: 1px solid #333;
            position: relative;
        }

        .response-area:before {
            content: 'Response Console';
            position: absolute;
            top: -10px;
            left: 20px;
            background: #1e1e1e;
            color: #00ff00;
            padding: 0 10px;
            font-size: 12px;
            font-weight: bold;
        }

        .status-success {
            color: #4CAF50;
            font-weight: bold;
        }

        .status-error {
            color: #FF6B6B;
            font-weight: bold;
        }

        .status-info {
            color: #2196F3;
            font-weight: bold;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .user-info {
                grid-template-columns: 1fr;
            }

            .endpoint-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="auth-logo">üîê</div>
        <h1>Digest Authentication Client</h1>
        <p class="subtitle">HTTP Digest Authentication Demo</p>
    </div>

    <div class="section">
        <h2>üë• User Selection</h2>
        <div class="user-info">
            <div class="user-card active" onclick="selectUser('john', 'password123')">
                <h4>John</h4>
                <p>Regular User</p>
            </div>
            <div class="user-card" onclick="selectUser('jane', 'secret456')">
                <h4>Jane</h4>
                <p>Regular User</p>
            </div>
            <div class="user-card" onclick="selectUser('admin', 'admin123')">
                <h4>Admin</h4>
                <p>Administrator</p>
            </div>
        </div>

        <div class="form-group">
            <label for="username">Username:</label>
            <input type="text" id="username" value="john" placeholder="Enter username">
        </div>
        <div class="form-group">
            <label for="password">Password:</label>
            <input type="password" id="password" value="password123" placeholder="Enter password">
        </div>
    </div>

    <div class="section">
        <h2>üîí Protected Endpoints</h2>
        <div class="endpoints">
            <div class="endpoint-section">
                <h3>üõ°Ô∏è Protected Routes</h3>
                <div class="endpoint-buttons">
                    <button class="btn btn-profile" onclick="testEndpoint('/profile/me')">
                        <span>üë§</span>
                        Profile (/profile/me)
                    </button>
                    <button class="btn btn-admin" onclick="testEndpoint('/admin')">
                        <span>üë®‚Äçüíº</span>
                        Admin (/admin)
                    </button>
                </div>
            </div>

            <div class="endpoint-section">
                <h3>üåê Public Routes</h3>
                <div class="endpoint-buttons">
                    <button class="btn btn-public" onclick="testEndpoint('/public')">
                        <span>üåç</span>
                        Public (/public)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>üíª Response Console</h2>
        <div class="response-area" id="responseArea">
            <div class="status-success">Digest Authentication Client ready!</div>
            <div>Click on any endpoint button to test authentication.</div>
        </div>

        <button class="btn btn-clear" onclick="clearResponse()" style="margin-top: 15px;">
            <span>üóëÔ∏è</span>
            Clear Response
        </button>
    </div>
</div>

<!-- CryptoJS library from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.2.0/crypto-js.min.js"></script>

<script>
    function hash(str, algorithm) {
        switch(algorithm) {
            case 'MD5':
                return CryptoJS.MD5(str).toString();
            case 'SHA-256':
                return CryptoJS.SHA256(str).toString();
            case 'SHA-256-sess':
                return CryptoJS.SHA256(str).toString();
            case 'SHA-512':
                return CryptoJS.SHA512(str).toString();
            default:
                logResponse(`Unsupported algorithm: ${algorithm}, falling back to MD5`, 'error');
                return CryptoJS.MD5(str).toString();
        }
    }

    // Generate random nonce
    function generateNonce() {
        return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
    }

    // Parse WWW-Authenticate header
    function parseWWWAuthenticate(headerValue) {
        const result = {};
        const regex = /(\w+)=("([^"]+)"|([^,\s]+))/g;
        let match;

        while ((match = regex.exec(headerValue)) !== null) {
            const key = match[1];
            const value = match[3] || match[4];
            result[key] = value;
        }

        return result;
    }

    // Parse QOP parameter and select the first supported one
    function selectQop(qopString) {
        if (!qopString) return 'auth';

        // Split by comma and trim whitespace
        const qopOptions = qopString.split(',').map(q => q.trim());

        // Prefer 'auth' if available, otherwise take the first one
        if (qopOptions.includes('auth')) {
            return 'auth';
        }

        return qopOptions[0] || 'auth';
    }

    // Log response
    function logResponse(message, type = 'info') {
        const responseArea = document.getElementById('responseArea');
        const timestamp = new Date().toLocaleTimeString();
        const className = type === 'error' ? 'status-error' : type === 'success' ? 'status-success' : 'status-info';

        responseArea.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
        responseArea.scrollTop = responseArea.scrollHeight;
    }

    // Select user
    function selectUser(username, password) {
        document.getElementById('username').value = username;
        document.getElementById('password').value = password;

        // Update active user card
        document.querySelectorAll('.user-card').forEach(card => {
            card.classList.remove('active');
        });
        event.target.closest('.user-card').classList.add('active');

        logResponse(`Selected user: ${username}`, 'info');
    }

    // Test endpoint
    async function testEndpoint(endpoint) {
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;

        if (!username || !password) {
            logResponse('Please enter username and password', 'error');
            return;
        }

        const url = `http://localhost:8080${endpoint}`;

        logResponse(`Testing ${endpoint}...`, 'info');
        logResponse(`Request: GET ${url}`, 'info');

        try {
            // First request - expect 401 for protected endpoints
            const response = await fetch(url, {
                method: 'GET',
                credentials: 'omit'
            });

            logResponse(`Response Status: ${response.status} ${response.statusText}`,
                response.status === 200 ? 'success' : 'info');

            if (response.status === 401) {
                const wwwAuth = response.headers.get('WWW-Authenticate');
                logResponse(`WWW-Authenticate: ${wwwAuth}`, 'info');

                if (wwwAuth && wwwAuth.startsWith('Digest')) {
                    const authParams = parseWWWAuthenticate(wwwAuth);
                    logResponse(`Parsed auth params: ${JSON.stringify(authParams, null, 2)}`, 'info');

                    const cnonce = generateNonce();
                    const algorithm = authParams.algorithm || 'MD5';
                    const qop = selectQop(authParams.qop);  // Fixed: select single QOP value
                    const nc = "00000001";

                    logResponse(`Selected QOP: ${qop} (from "${authParams.qop}")`, 'info');
                    logResponse(`Using algorithm: ${algorithm}`, 'info');

                    // Compute digest with the correct algorithm
                    const hashInput1 = `${username}:${authParams.realm}:${password}`;
                    const hashInput2 = `GET:${endpoint}`;
                    const hash1 = hash(hashInput1, algorithm);  // Fixed: use correct algorithm
                    const hash2 = hash(hashInput2, algorithm);  // Fixed: use correct algorithm
                    const finalInput = `${hash1}:${authParams.nonce}:${nc}:${cnonce}:${qop}:${hash2}`;
                    const digestResponse = hash(finalInput, algorithm);  // Fixed: use correct algorithm

                    logResponse(`Digest computation using ${algorithm}:`, 'info');
                    logResponse(`  HA1 = ${algorithm}("${hashInput1}") = ${hash1}`, 'info');
                    logResponse(`  HA2 = ${algorithm}("${hashInput2}") = ${hash2}`, 'info');
                    logResponse(`  Response = ${algorithm}("${finalInput}") = ${digestResponse}`, 'info');

                    // Create authorization header with proper opaque handling
                    const opaque = authParams.opaque || '';
                    const authHeader = `Digest username="${username}", realm="${authParams.realm}", nonce="${authParams.nonce}", uri="${endpoint}", algorithm="${algorithm}", qop="${qop}", nc="${nc}", cnonce="${cnonce}", response="${digestResponse}", userhash=false, opaque="${opaque}"`;

                    logResponse(`Authorization: ${authHeader}`, 'info');

                    // Make the authenticated request
                    const authResponse = await fetch(url, {
                        method: 'GET',
                        headers: {
                            'Authorization': authHeader
                        },
                        credentials: 'omit'
                    });

                    logResponse(`Response: ${authResponse.status} ${authResponse.statusText}`,
                        authResponse.status === 200 ? 'success' : 'error');

                    if (authResponse.status === 200) {
                        const responseText = await authResponse.text();
                        logResponse(`Success! Response Body: ${responseText}`, 'success');
                    } else {
                        const responseText = await authResponse.text();
                        if (responseText) {
                            logResponse(`Failed. Response Body: ${responseText}`, 'error');
                        } else {
                            logResponse(`Failed. Empty response body`, 'error');
                        }

                        if (authResponse.status === 401) {
                            const newChallenge = authResponse.headers.get('WWW-Authenticate');
                            if (newChallenge) {
                                logResponse(`New challenge: ${newChallenge}`, 'error');
                            }
                        }
                    }
                } else {
                    logResponse('No valid WWW-Authenticate header found', 'error');
                }
            } else {
                // Public endpoint or already authenticated
                const responseText = await response.text();
                logResponse(`Response Body: ${responseText}`, 'success');
            }

        } catch (error) {
            logResponse(`Error: ${error.message}`, 'error');
        }

        logResponse('---', 'info');
    }

    // Clear response
    function clearResponse() {
        document.getElementById('responseArea').innerHTML =
            '<div class="status-success">Digest Authentication Client ready!</div>' +
            '<div>Click on any endpoint button to test authentication.</div>';
    }

    // Initialize
    logResponse('Digest Authentication Client ready!', 'success');
    logResponse('Server should be running on http://localhost:8080', 'info');
    logResponse('Available users: john/password123, jane/secret456, admin/admin123', 'info');
    logResponse('Using CryptoJS library for secure MD5 and SHA-256 hashing', 'info');
    logResponse('Authentication format: RFC 2617 compliant with ZIO HTTP', 'info');
</script>
</body>
</html>
