# This workflow is manually maintained and not generated by sbt-github-actions
name: PR Maintenance

on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
  schedule:
    - cron: '0 0 * * *'  # Run daily at midnight UTC

jobs:
  check-fixes-reference:
    name: Check Fixes Reference
    if: github.event_name == 'pull_request' && github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    steps:
      - name: Check for fixes reference
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const body = pr.body || '';
            const title = pr.title || '';
            
            // Check for various GitHub linking keywords
            const fixesPattern = /(?:fix|fixes|fixed|close|closes|closed|resolve|resolves|resolved)\s+#\d+/i;
            
            const hasFixesReference = fixesPattern.test(body) || fixesPattern.test(title);
            
            if (!hasFixesReference) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `üëã Hi! It looks like this PR doesn't reference an issue using GitHub's linking keywords (e.g., "fixes #123", "closes #456", "resolves #789").

Please consider adding a reference to help maintain traceability between issues and PRs. You can use any of these formats:
- \`fixes #123\`
- \`closes #123\`
- \`resolves #123\`

This helps automatically close the related issue when the PR is merged. Thanks! üôè`
              });
            }

  cleanup-stale-prs:
    name: Close Stale PRs
    if: github.event_name == 'schedule'
    runs-on: ubuntu-latest
    steps:
      - name: Close PRs without successful builds
        uses: actions/github-script@v7
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            const fiveDaysAgo = new Date();
            fiveDaysAgo.setDate(fiveDaysAgo.getDate() - 5);
            
            for (const pr of prs) {
              // Skip draft PRs
              if (pr.draft) continue;
              
              const prCreated = new Date(pr.created_at);
              const prUpdated = new Date(pr.updated_at);
              
              // Check if PR is older than 5 days
              if (prUpdated < fiveDaysAgo) {
                // Get the latest commit status
                const { data: statuses } = await github.rest.repos.listCommitStatusesForRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: pr.head.sha
                });
                
                // Get check runs for the commit
                const { data: checkRuns } = await github.rest.checks.listForRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: pr.head.sha
                });
                
                // Check if there are any successful builds
                const hasSuccessfulStatus = statuses.some(status => status.state === 'success');
                const hasSuccessfulCheck = checkRuns.check_runs.some(check => check.conclusion === 'success');
                
                // If no successful builds found, close the PR
                if (!hasSuccessfulStatus && !hasSuccessfulCheck) {
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    body: `ü§ñ This PR has been automatically closed because it hasn't had a successful build in the last 5 days.

If you're still working on this PR, please:
1. Fix any failing builds
2. Reopen the PR when ready

Thanks for your contribution! üôè`
                  });
                  
                  await github.rest.pulls.update({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number,
                    state: 'closed'
                  });
                  
                  console.log(`Closed PR #${pr.number}: ${pr.title}`);
                }
              }
            }